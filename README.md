# voting_service


# Содержание

1. [Описание задачи](#Описание-задачи)
1. [Запуск](#Запуск)
1. [Тестирование](#Тестирование)
1. [Нагрузочное тестирование](#Нагрузочное-тестирование)
1. [Схема базы данных](#Схема-базы-данных)
1. [API](#API)
1. [Декомпозиция задания](#Декомпозиция-задания)
1. [Дальнейшее развитие](#Дальнейшее-развитие)

# Описание задачи

Нужно реализовать HTTP сервис для голосования. Например, для выбора самого популярного покемона. UI не нужен, достаточно сделать JSON API сервис. Должна быть возможность:

* Создать новое голосование с разными вариантами ответов
* Отдать свой голос за какой-либо вариант
* Получить текущий результат голосования

# Запуск

* Клонировать проект с репозитория GitHub
```
git clone https://github.com/oljakon/voting_service.git
```

* Перейти в директорию *voting_service*
```
cd voting_service/
```

* Запустить *docker_compose*
```
docker-compose up
```

# Тестирование

* Запуск тестов
```
docker-compose run web ./manage.py test
```

* Процент покрытия тестами
```
docker-compose run web coverage run --source=api manage.py test
docker-compose run web coverage report
```

| Name          | Statements    | Missing       | Coverage      |
| ------------- | ------------- | ------------- | ------------- |
api/\_\_init\_\_.py |                 0 |     0 |  100% |
api/admin.py        |                 4 |     0 |  100% |
api/apps.py         |                 4 |     0 |  100% |
api/models.py       |                11 |     2 |   82% |
api/serializers.py  |                10 |     0 |  100% |
api/tests/\_\_init\_\_.py |           0 |     0 |  100% |
api/tests/test_models.py  |          33 |     0 |  100% |
api/tests/test_serializers.py |      28 |     0 |  100% |
api/tests/test_views.py   |          82 |     0 |  100% |
api/urls.py               |           3 |     0 |  100% |
api/views.py              |          42 |     0 |  100% |
Total                     |         223 |     2 |   99% |


# Нагрузочное тестирование

Нагрузочное тестирование проведено для 1000 запросов с помощью утилиты Apache Benchmark. Результаты представлены в файле [ab_results.md](./ab_results.md)


# Схема базы данных

[Miro](https://miro.com/app/board/o9J_l-evOx8=/)


# API

Документация в формате Swagger находится по адресу: http://127.0.0.1:8000/api/

Тело запроса и ответа - в формате JSON.

В случае возникновения ошибки возвращается ее HTTP код и краткое описание.

При введении неверных параметров запроса возвращается ошибка 400 (Bad Request).


## POST /api/createPoll/

Создать голосование с вариантами ответов.

* Тело запроса:
  * poll - параметры голосования,
    * name - название голосования,
  * choices - варианты голосования.
* Тело ответа (код 201):
  * id - id созданного голосования,
  * name - название созданного голосвания.

__Пример:__

Запрос:
```
{
    "poll": {
        "name": "Best pokemon"
    }, 
    "choices": [
        "Pikachu",
        "Mew"
    ]
}
```

Ответ:
```
{
    "id": 1,
    "name": "Best pokemon"
}
```

## POST /api/poll/

Проголосовать за один из вариантов голосования.

* Тело запроса:
  * poll_id - id голосования,
  * choice_id - id варианта голосования.
* Тело ответа (код 200):
  * сообщение "Vote taken" 

Если вариант голосования, соответствующий введенному choice_id, не относится к голосованию с poll_id, будет возвращен код ошибки 404.

Если голосование poll_id или вариант choice_id не существуют, будет возвращен код ошибки 404.

__Пример:__

Запрос:
```
{ 
    "poll_id": 1, 
    "choice_id": 2
}
```

Ответ:
```
{
    "Vote taken"
}
```

## POST /api/getResult/

Получить результат по конкретному голосованию.

* Тело запроса:
  * poll_id - id голосования,
* Тело ответа (код 200):
  * "вариант": количество голосов

Если голосование с poll_id не найдено, будет возвращен код ошибки 404.

__Пример:__

Запрос:
```
{ 
    "poll_id": 1
}
```

Ответ:
```
{
    "Pikachu": 1,
    "Mew": 0
}
```

# Декомпозиция задания

1. Создание проекта
   * создание репозитория с проектом Django;
   * добавление репозитория на Github.
2. Создание базы данных для проекта
   * проектирование схемы базы данных;
   * создание модели голосования (Poll);
   * создание модели варианта голосования (PollChoice);
   * сериализация созданных моделей (PollSerializer и PollChoiceSerializer);
   * настройка отображения моделей в панели администратора;
   * подключение PostgeSQL.
3. Реализация API
   * POST метод создания голосования;
   * POST метод голосования за конкретный вариант;
   * POST метод получения результатов конкретного голосования;
   * добавление автодокументирования API.
4. Тестирование
   * тестирование моделей;
   * тестирование сериализаторов;
   * тестирование методов;
   * создание отчета с процентом покрытия кода тестами;
   * нагрузочное тестирование.
5. Контейнеризация
   * настройка Docker.


# Дальнейшее развитие

> Опишите, как изменится архитектура, если мы ожидаем большую нагрузку (Реализация не требуется)

1. добавить базу данных Redis для хранения кэша;
2. добавить балансировку запросов между несколькими серверами с помощью веб-сервера nginx.

> Опишите, как можно защититься от накруток (Реализация не требуется)

1. отслеживать уникальных посетителей путем добавления заголовков в HTTP-ответ. При первом посещении пользователем сайта в заголовок проставляется уникальный хеш. Сервер должен выполнять проверку хеша: если он не изменился, то сервер отправляет ответ с кодом 304 (Not Modified), из чего следует, что запрашиваемый ресурс можно взять из кэша;
2. для защиты от накрутки ботов можно добавить капчи и honeypot;
3. для защиты от накрутки со стороны пользователей можно отслеживать дельту роста количества голосов. Если в какой-то момент наблюдается резкий прирост голосов (по сравнению с приростом ранее), данная активность считается подозрительной и голоса замораживаются.
